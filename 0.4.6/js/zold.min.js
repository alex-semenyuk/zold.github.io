/*! zold 2018-07-16 */

$.fn.colorize=function(t){var e=parseFloat(this.text()),o=Object.keys(t).map(function(t){return parseInt(t)}).sort(function(t,e){return t-e}).reverse();for(i=0;i<o.length;++i){var a=o[i];if(a<=e)return void this.addClass(t[a]);this.removeClass(t[a])}return this};var delay=5e3;function health_init(){window.location.protocol.startsWith("https")?$(location).attr("href","http://www.zold.io/health.html"):(root="b1.zold.io",$("#head").html("Wait a second, we are loading the list of nodes from "+root+"..."),$.getJSON("http://"+root+"/remotes",function(t){$("#head").html('The node <a href="http://'+root+'">'+root+"</a> currently sees <strong>"+t.all.length+" nodes</strong> (refresh the page to update):"),$.each(t.all.sort(function(t){return t.host}),function(t,e){var o=e.host+":"+e.port;$("#health tbody").append('<tr data-addr="'+o+'"><td class="host"><a href="http://'+o+'/">'+e.host+'</a></td><td class="port">'+e.port+'</td><td class="ping data"></td><td class="cpus data"></td><td class="threads data"></td><td class="score data"></td><td class="wallets data"></td><td class="version data"></td><td class="nscore data"></td><td class="remotes data"></td><td class="history data"></td><td class="queue data"></td><td class="qage data"></td><td class="speed data"></td><td class="age data"></td><td class="wallet"></td></tr>'),window.setTimeout(function(){health_node(o)},0)})}).fail(function(){console.log("Failed to load the list of remotes from "+root)}))}function health_check(){var o=$("#wallet").val();$("#health tr[data-addr]").each(function(){var t=$(this).data("addr"),a=$(this).find("td.wallet"),e="http://"+t+"/wallet/"+o+"/balance";a.text("checking..."),a.attr("title",e),$.getJSON(e,function(t){a.text(Math.round(parseInt(t)/Math.pow(2,32),2)+"ZLD").removeClass("red")}).fail(function(t,e,o){a.text(t.status).addClass("red")})})}function health_node(o){var a=$('#health tr[data-addr="'+o+'"]'),r=new Date;a.find("td.ping").html('<div class="spinner">&nbsp;</div>'),$.getJSON("http://"+o+"/",function(t){var e=new Date-r;a.find("td.ping").text(e).colorize({200:"red",0:"green"}),a.find("td.cpus").text(t.cpus),a.find("td.threads").text(t.threads),a.find("td.score").text(t.score.value).colorize({16:"green",4:"orange",0:"red"}),a.find("td.wallets").text(t.wallets),a.find("td.remotes").text(t.remotes),a.find("td.version").text(t.version+"/"+t.protocol),a.find("td.nscore").text(t.nscore),a.find("td.age").text(parseFloat(Math.round(t.hours_alive))),a.find("td.history").text(t.entrance.history_size).colorize({8:"green",0:"red"}),a.find("td.queue").text(t.entrance.queue).colorize({32:"red",8:"orange",0:"green"}),a.find("td.qage").text(Math.round(t.entrance.queue_age)).colorize({180:"red",60:"orange",0:"green"}),a.find("td.speed").text(Math.round(t.entrance.speed)).colorize({32:"red",16:"orange",0:"green"}),window.setTimeout(function(){health_node(o)},delay)})}var messagesRepository=[];function init(){if(window.location.protocol.startsWith("https"))$(location).attr("href","http://www.zold.io/map.html");else{startLoader();var t=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(55.751244,37.618423),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:2});t.addListener("drag",function(){(t.getBounds().getSouthWest().lat()<-85||85<t.getBounds().getNorthEast().lat())&&t.setOptions({zoom:2,center:new google.maps.LatLng(0,0)})}),refresh("b2.zold.io:4096",t)}}function startLoader(){$("#header").html("Loading..."),$("#remotes-table").append('<tr rel="loader"><td colspan="4">Loading...</td></tr>')}function refresh(e,o){$.getJSON("http://"+e+"/",function(t){$('#remotes-table tr[rel="loader"]').hide(),$("#header").html("Version: "+t.version+"<br/>Host: "+t.score.host+":"+t.score.port+"<br/>Score: "+t.score.value+"<br/>Remote nodes: "+t.remotes+"<br/>Wallets: "+t.wallets),refresh_list(e,o),window.setTimeout(function(){refresh(e,o)},1e4)}).fail(function(){createMessage("Main node retrieve fail, try to refresh page")})}function refresh_list(a,r){$.getJSON("http://"+a+"/remotes",function(t){var e=t.all,o=(new Date).getTime();console.log(e.length+" remote nodes found at "+a),$.each(e,function(t,e){$('#remotes-table tr[data-coords="'+e.host+":"+e.port+'"]').first().attr("data-check",o)}),$("#remotes-table .zold-node:not([data-check="+o+"])").remove(),put_markers(r,e)}).fail(function(){createMessage("Remote list retrieve fail, try to refresh page")})}function put_markers(d,t){$.each(t,function(t,e){var o=e.host,a=e.port,r=o+":"+a,n=$('#remotes-table tr[data-coords="'+r+'"]');if(n.length){var s=n.first();$.getJSON("http://"+r+"/",function(t){s.html("<td>"+makeALink(r)+"</td><td>"+t.score.value+"</td><td>"+t.wallets+"</td><td>"+t.version+"</td>"),s.addClass("blink"),setTimeout(function(t){t.removeClass("blink")},3e3,s),o.match(/^[0-9\.]+$/)?put_marker_by_ip(d,o+":"+a,o,a):put_marker_by_host(d,o+":"+a,o,a)}).done(function(){s.removeClass("node-down"),s.addClass("node-up")}).fail(function(){s.removeClass("node-up"),s.addClass("node-down")})}else $("#remotes-table").append('<tr class="zold-node" data-coords="'+r+'"><td>'+makeALink(r)+"</td> <td colspan=3>&nbsp;</td> </tr>")})}function put_marker_by_host(e,o,a,r){$.getJSON("https://api.exana.io/dns/"+a+"/a",function(t){ip=$.grep(t.answer,function(t,e){return"A"==t.type})[0].rdata,console.log("Host "+a+" resolved to "+ip),put_marker_by_ip(e,o,ip,r)}).fail(function(){createMessage("Failed to find IP for "+a)})}function put_marker_by_ip(a,r,n,t){$.getJSON("http://www.geoplugin.net/json.gp?ip="+n,function(t){var e=parseFloat(t.geoplugin_latitude),o=parseFloat(t.geoplugin_longitude);console.log(n+" located at "+e+"/"+o),new google.maps.Marker({position:{lat:e,lng:o},map:a,title:r}),console.log("Marker set for "+r+" at "+e+"/"+o)}).fail(function(){createMessage("Failed to find geo-location for "+n)})}function createMessage(t){messagesRepository.push(t),printMessages(messagesRepository=messagesRepository.reverse().slice(0,8))}function printMessages(t){var e=$(".messages-container");e.html(""),t.forEach(function(t){console.log(t),e.append('<div class="message-warning">'+t+"</div>")})}function makeALink(t){return'<a href="http://'+t+'/">'+t+"</a>"}