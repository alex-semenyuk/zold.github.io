/*! zold 2018-07-21 */

$.fn.colorize=function(t){var e=parseFloat(this.text()),a=Object.keys(t).map(function(t){return parseInt(t)}).sort(function(t,e){return t-e}).reverse();for(i=0;i<a.length;++i){var o=a[i];if(o<=e)return void this.addClass(t[o]);this.removeClass(t[o])}return this};var delay=5e3,seen_nodes=new Set([]);function health_init(){window.location.protocol.startsWith("https")?$(location).attr("href","http://www.zold.io/health.html"):(root="b1.zold.io",$("#head").html("Wait a second, we are loading the list of nodes from "+root+"..."),$.getJSON("http://"+root+"/remotes",function(t){$("#head").html('The node <a href="http://'+root+'">'+root+"</a> currently sees <strong>"+t.all.length+" nodes</strong> (refresh the page to update):"),$.each(t.all.sort(function(t){return t.host}),function(t,e){var a=e.host+":"+e.port;$("#health tbody").append('<tr data-addr="'+a+'"><td class="host"><a href="http://'+a+'/">'+e.host+'</a></td><td class="port">'+e.port+'</td><td class="ping data"></td><td class="flag data" data-ip="'+e.host+'"></td><td class="cpus data"></td><td class="threads data"></td><td class="score data"></td><td class="wallets data"></td><td class="version data"></td><td class="nscore data"></td><td class="remotes data"></td><td class="history data"></td><td class="queue data"></td><td class="qage data"></td><td class="speed data"></td><td class="age data"></td><td class="wallet"></td></tr>'),health_flag(e.host),window.setTimeout(function(){health_node(a)},0)})}).fail(function(){console.log("Failed to load the list of remotes from "+root)}))}function health_flag(t){var a=$('#health td[data-ip="'+t+'"]');$.getJSON("https://ssl.geoplugin.net/json.gp?k=af0ad95fd7caa623&ip="+a.data("ip"),function(t){var e=t.geoplugin_countryCode;a.html('<img src="https://flagpedia.net/data/flags/normal/'+e.toLowerCase()+'.png" alt="'+e+'" style="width:1em;"/>')}).fail(function(){a.text("?")})}function health_check_wallet(){var a=$("#wallet").val();$("#health tr[data-addr]").each(function(){var t=$(this).data("addr"),o=$(this).find("td.wallet"),e="http://"+t+"/wallet/"+a+"/balance";o.text("checking...").addClass("gray").removeClass("green"),o.attr("title",e),$.getJSON(e,function(t){o.text(Math.round(parseInt(t)/Math.pow(2,32),2)+"ZLD").removeClass("gray red").addClass("green")}).fail(function(t,e,a){o.text(t.status).addClass("red")})})}function health_node(a){var o=$('#health tr[data-addr="'+a+'"]'),n=new Date;o.find("td.ping").html('<div class="spinner">&nbsp;</div>'),$.getJSON("http://"+a+"/",function(t){var e=new Date-n;o.find("td.ping").text(e).colorize({200:"red",0:"green"}),o.find("td.cpus").text(t.cpus),o.find("td.threads").text(t.threads),o.find("td.score").text(t.score.value).colorize({16:"green",4:"orange",0:"red"}),o.find("td.wallets").text(t.wallets),o.find("td.remotes").text(t.remotes),o.find("td.version").text(t.version+"/"+t.protocol),o.find("td.nscore").text(t.nscore),o.find("td.age").text(parseFloat(Math.round(t.hours_alive))),o.find("td.history").text(t.entrance.history_size).colorize({8:"green",0:"red"}),o.find("td.queue").text(t.entrance.queue).colorize({32:"red",8:"orange",0:"green"}),0==t.entrance.queue_age?o.find("td.qage").html("&mdash;"):o.find("td.qage").text(Math.round(t.entrance.queue_age)).colorize({180:"red",60:"orange",0:"green"}),o.find("td.speed").text(Math.round(t.entrance.speed)).colorize({32:"red",16:"orange",0:"green"}),$.getJSON("http://"+a+"/remotes",function(t){seen_nodes.add(a),$.each(t.all,function(t,e){seen_nodes.add(e.host+":"+e.port)}),$("#total_nodes").text(seen_nodes.size),health_update_cost()})}).always(function(){window.setTimeout(function(){health_node(a)},delay)}).fail(function(t,e,a){o.find("td.ping").text("#"+t.status).addClass("red")})}function health_update_cost(){var e=0;$("#health td.cpus").each(function(){var t=$(this).text();t.match(/^[0-9]+$/)&&(e+=parseInt(t))}),$("#total_cpus").text(e);var t=parseInt($("#total_nodes").text()),a=$("#health td.cpus").length;$("#total_dollars").text((.16*t*e/a).toFixed(2))}function map_init(){if(window.location.protocol.startsWith("https"))$(location).attr("href","http://www.zold.io/map.html");else{var t=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(55.751244,37.618423),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:2});t.addListener("drag",function(){(t.getBounds().getSouthWest().lat()<-85||85<t.getBounds().getNorthEast().lat())&&t.setOptions({zoom:2,center:new google.maps.LatLng(0,0)})}),map_refresh("b1.zold.io",t)}}function map_refresh(t,a){$.getJSON("http://"+t+"/remotes",function(t){$.each(t.all,function(t,e){e.host.match(/^[0-9\.]+$/)?map_by_ip(a,e.host,e.port):map_by_host(a,e.host,e.port)})})}function map_by_host(a,t,o){$.getJSON("https://api.exana.io/dns/"+t+"/a",function(t){var e=$.grep(t.answer,function(t,e){return"A"==t.type})[0].rdata;map_by_ip(a,e,o)}).fail(function(){console.log("Failed to find IP for "+t)})}function map_by_ip(o,n,d){$.getJSON("http://www.geoplugin.net/json.gp?ip="+n,function(t){var e=parseFloat(t.geoplugin_latitude),a=parseFloat(t.geoplugin_longitude);new google.maps.Marker({position:{lat:e,lng:a},map:o,title:n+":"+d})}).fail(function(){console.log("Failed to find geo-location for "+n)})}