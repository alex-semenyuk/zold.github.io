/*! zold 2018-07-08 */

var messagesRepository=[];function init(){startLoader();var e=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(55.751244,37.618423),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:2});e.addListener("drag",function(){(e.getBounds().getSouthWest().lat()<-85||85<e.getBounds().getNorthEast().lat())&&e.setOptions({zoom:2,center:new google.maps.LatLng(0,0)})}),refresh("b2.zold.io:4096",e)}function startLoader(){$("#header").html("Loading..."),$("#remotes-table").append('<tr rel="loader"><td colspan="4">Loading...</td></tr>')}function refresh(t,o){$.getJSON("http://"+t+"/",function(e){$('#remotes-table tr[rel="loader"]').hide(),$("#header").html("Version: "+e.version+"<br/>Host: "+e.score.host+":"+e.score.port+"<br/>Score: "+e.score.value+"<br/>Remote nodes: "+e.remotes+"<br/>Wallets: "+e.wallets),refresh_list(t,o),window.setTimeout(function(){refresh(t,o)},1e4)}).fail(function(){createMessage("Main node retrieve fail, try to refresh page")})}function refresh_list(a,s){$.getJSON("http://"+a+"/remotes",function(e){var t=e.all,o=(new Date).getTime();console.log(t.length+" remote nodes found at "+a),$.each(t,function(e,t){$('#remotes-table tr[data-coords="'+t.host+":"+t.port+'"]').first().attr("data-check",o)}),$("#remotes-table .zold-node:not([data-check="+o+"])").remove(),put_markers(s,t)}).fail(function(){createMessage("Remote list retrieve fail, try to refresh page")})}function put_markers(i,e){$.each(e,function(e,t){var o=t.host,a=t.port,s=o+":"+a,n=$('#remotes-table tr[data-coords="'+s+'"]');if(n.length){var r=n.first();$.getJSON("http://"+s+"/",function(e){r.html("<td>"+makeALink(s)+"</td><td>"+e.score.value+"</td><td>"+e.wallets+"</td><td>"+e.version+"</td>"),r.addClass("blink"),setTimeout(function(e){e.removeClass("blink")},3e3,r),o.match(/^[0-9\.]+$/)?put_marker_by_ip(i,o+":"+a,o,a):put_marker_by_host(i,o+":"+a,o,a)}).done(function(){r.removeClass("node-down"),r.addClass("node-up")}).fail(function(){r.removeClass("node-up"),r.addClass("node-down")})}else $("#remotes-table").append('<tr class="zold-node" data-coords="'+s+'"><td>'+makeALink(s)+"</td> <td colspan=3>&nbsp;</td> </tr>")})}function put_marker_by_host(t,o,a,s){$.getJSON("https://api.exana.io/dns/"+a+"/a",function(e){ip=$.grep(e.answer,function(e,t){return"A"==e.type})[0].rdata,console.log("Host "+a+" resolved to "+ip),put_marker_by_ip(t,o,ip,s)}).fail(function(){createMessage("Failed to find IP for "+a)})}function put_marker_by_ip(a,s,n,e){$.getJSON("http://www.geoplugin.net/json.gp?ip="+n,function(e){var t=parseFloat(e.geoplugin_latitude),o=parseFloat(e.geoplugin_longitude);console.log(n+" located at "+t+"/"+o),new google.maps.Marker({position:{lat:t,lng:o},map:a,title:s}),console.log("Marker set for "+s+" at "+t+"/"+o)}).fail(function(){createMessage("Failed to find geo-location for "+n)})}function createMessage(e){messagesRepository.push(e),printMessages(messagesRepository=messagesRepository.reverse().slice(0,8))}function printMessages(e){var t=$(".messages-container");t.html(""),e.forEach(function(e){console.log(e),t.append('<div class="message-warning">'+e+"</div>")})}function makeALink(e){return'<a href="http://'+e+'/">'+e+"</a>"}