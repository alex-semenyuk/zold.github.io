/*! zold 2018-07-13 */

var delay=2e3;function health_init(){root="b1.zold.io",$.getJSON("http://"+root+"/remotes",function(e){$.each(e.all,function(e,t){var o=t.host+":"+t.port;$("#health tbody").append('<tr data-addr="'+o+'"><td class="host"><a href="http://'+o+'/">'+t.host+'</a></td><td class="port">'+t.port+'</td><td class="cpus"></td><td class="score"></td><td class="wallets"></td><td class="version"></td><td class="nscore"></td><td class="remotes"></td><td class="age"></td><td class="issues"></td></tr>'),window.setTimeout(function(){health_node(o)},delay)})}).fail(function(){console.log("Failed to load the list of remotes from "+root)})}function health_node(o){var s=$('#health tr[data-addr="'+o+'"]');s.find("td.port").addClass("gray"),$.getJSON("http://"+o+"/",function(e){s.find("td.cpus").text(e.cpus);var t=s.find("td.score");t.text(e.score.value),t.removeClass("green orange red"),15<e.score.value?t.addClass("green"):3<e.score.value?t.addClass("orange"):t.addClass("red"),s.find("td.wallets").text(e.wallets),s.find("td.remotes").text(e.remotes),s.find("td.version").text(e.version+"/"+e.protocol),s.find("td.nscore").text(e.nscore),s.find("td.age").text(parseFloat(Math.round(e.hours_alive))),s.find("td.issues").text(issues(e).join("; ")),s.find("td.port").removeClass("gray"),window.setTimeout(function(){health_node(o)},delay)})}function issues(e){var t=[];"zold"!=e.network&&t.push('Network name is wrong: "'+e.network+'"');var o=(e.entrance.history.match(/ /g)||[]).length;return o<8&&t.push("History is too short: "+o),t}var messagesRepository=[];function init(){startLoader();var e=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(55.751244,37.618423),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:2});e.addListener("drag",function(){(e.getBounds().getSouthWest().lat()<-85||85<e.getBounds().getNorthEast().lat())&&e.setOptions({zoom:2,center:new google.maps.LatLng(0,0)})}),refresh("b2.zold.io:4096",e)}function startLoader(){$("#header").html("Loading..."),$("#remotes-table").append('<tr rel="loader"><td colspan="4">Loading...</td></tr>')}function refresh(t,o){$.getJSON("http://"+t+"/",function(e){$('#remotes-table tr[rel="loader"]').hide(),$("#header").html("Version: "+e.version+"<br/>Host: "+e.score.host+":"+e.score.port+"<br/>Score: "+e.score.value+"<br/>Remote nodes: "+e.remotes+"<br/>Wallets: "+e.wallets),refresh_list(t,o),window.setTimeout(function(){refresh(t,o)},1e4)}).fail(function(){createMessage("Main node retrieve fail, try to refresh page")})}function refresh_list(s,a){$.getJSON("http://"+s+"/remotes",function(e){var t=e.all,o=(new Date).getTime();console.log(t.length+" remote nodes found at "+s),$.each(t,function(e,t){$('#remotes-table tr[data-coords="'+t.host+":"+t.port+'"]').first().attr("data-check",o)}),$("#remotes-table .zold-node:not([data-check="+o+"])").remove(),put_markers(a,t)}).fail(function(){createMessage("Remote list retrieve fail, try to refresh page")})}function put_markers(d,e){$.each(e,function(e,t){var o=t.host,s=t.port,a=o+":"+s,r=$('#remotes-table tr[data-coords="'+a+'"]');if(r.length){var n=r.first();$.getJSON("http://"+a+"/",function(e){n.html("<td>"+makeALink(a)+"</td><td>"+e.score.value+"</td><td>"+e.wallets+"</td><td>"+e.version+"</td>"),n.addClass("blink"),setTimeout(function(e){e.removeClass("blink")},3e3,n),o.match(/^[0-9\.]+$/)?put_marker_by_ip(d,o+":"+s,o,s):put_marker_by_host(d,o+":"+s,o,s)}).done(function(){n.removeClass("node-down"),n.addClass("node-up")}).fail(function(){n.removeClass("node-up"),n.addClass("node-down")})}else $("#remotes-table").append('<tr class="zold-node" data-coords="'+a+'"><td>'+makeALink(a)+"</td> <td colspan=3>&nbsp;</td> </tr>")})}function put_marker_by_host(t,o,s,a){$.getJSON("https://api.exana.io/dns/"+s+"/a",function(e){ip=$.grep(e.answer,function(e,t){return"A"==e.type})[0].rdata,console.log("Host "+s+" resolved to "+ip),put_marker_by_ip(t,o,ip,a)}).fail(function(){createMessage("Failed to find IP for "+s)})}function put_marker_by_ip(s,a,r,e){$.getJSON("http://www.geoplugin.net/json.gp?ip="+r,function(e){var t=parseFloat(e.geoplugin_latitude),o=parseFloat(e.geoplugin_longitude);console.log(r+" located at "+t+"/"+o),new google.maps.Marker({position:{lat:t,lng:o},map:s,title:a}),console.log("Marker set for "+a+" at "+t+"/"+o)}).fail(function(){createMessage("Failed to find geo-location for "+r)})}function createMessage(e){messagesRepository.push(e),printMessages(messagesRepository=messagesRepository.reverse().slice(0,8))}function printMessages(e){var t=$(".messages-container");t.html(""),e.forEach(function(e){console.log(e),t.append('<div class="message-warning">'+e+"</div>")})}function makeALink(e){return'<a href="http://'+e+'/">'+e+"</a>"}