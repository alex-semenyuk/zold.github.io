/*! zold 2018-07-13 */

var delay=2e3;function health_init(){window.location.protocol.startsWith("https")?$(location).attr("href","http://www.zold.io/health.html"):(root="b1.zold.io",$("#head").html("Wait a second, we are loading the list of nodes from "+root+"..."),$.getJSON("http://"+root+"/remotes",function(t){$("#head").html('The node <a href="http://'+root+'">'+root+"</a> currently sees <strong>"+t.all.length+" nodes</strong> (refresh the page to update):"),$.each(t.all,function(t,e){var o=e.host+":"+e.port;$("#health tbody").append('<tr data-addr="'+o+'"><td class="host"><a href="http://'+o+'/">'+e.host+'</a></td><td class="port">'+e.port+'</td><td class="ping"></td><td class="cpus"></td><td class="score"></td><td class="wallets"></td><td class="version"></td><td class="nscore"></td><td class="remotes"></td><td class="history"></td><td class="queue"></td><td class="age"></td><td class="issues"></td></tr>'),window.setTimeout(function(){health_node(o)},delay)})}).fail(function(){console.log("Failed to load the list of remotes from "+root)}))}function health_node(a){var r=$('#health tr[data-addr="'+a+'"]'),n=new Date;r.find("td.port").addClass("gray"),$.getJSON("http://"+a+"/",function(t){var e=new Date-n,o=r.find("td.ping");o.text(e),200<e?o.removeClass("green").addClass("red"):o.removeClass("red").addClass("green"),r.find("td.cpus").text(t.cpus);var s=r.find("td.score");s.text(t.score.value),s.removeClass("green orange red"),15<t.score.value?s.addClass("green"):3<t.score.value?s.addClass("orange"):s.addClass("red"),r.find("td.wallets").text(t.wallets),r.find("td.remotes").text(t.remotes),r.find("td.version").text(t.version+"/"+t.protocol),r.find("td.nscore").text(t.nscore),r.find("td.age").text(parseFloat(Math.round(t.hours_alive))),r.find("td.history").text((t.entrance.history.match(/ /g)||[]).length),r.find("td.queue").text(t.entrance.queue),r.find("td.issues").text(issues(t).join("; ")),r.find("td.port").removeClass("gray"),window.setTimeout(function(){health_node(a)},delay)})}function issues(t){var e=[];return"zold"!=t.network&&e.push("Network name is wrong!"),(t.entrance.history.match(/ /g)||[]).length<8&&e.push("History is too short!"),16<t.entrance.queue&&e.push("Queue is too long!"),e}var messagesRepository=[];function init(){if(window.location.protocol.startsWith("https"))$(location).attr("href","http://www.zold.io/map.html");else{startLoader();var t=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(55.751244,37.618423),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:2});t.addListener("drag",function(){(t.getBounds().getSouthWest().lat()<-85||85<t.getBounds().getNorthEast().lat())&&t.setOptions({zoom:2,center:new google.maps.LatLng(0,0)})}),refresh("b2.zold.io:4096",t)}}function startLoader(){$("#header").html("Loading..."),$("#remotes-table").append('<tr rel="loader"><td colspan="4">Loading...</td></tr>')}function refresh(e,o){$.getJSON("http://"+e+"/",function(t){$('#remotes-table tr[rel="loader"]').hide(),$("#header").html("Version: "+t.version+"<br/>Host: "+t.score.host+":"+t.score.port+"<br/>Score: "+t.score.value+"<br/>Remote nodes: "+t.remotes+"<br/>Wallets: "+t.wallets),refresh_list(e,o),window.setTimeout(function(){refresh(e,o)},1e4)}).fail(function(){createMessage("Main node retrieve fail, try to refresh page")})}function refresh_list(s,a){$.getJSON("http://"+s+"/remotes",function(t){var e=t.all,o=(new Date).getTime();console.log(e.length+" remote nodes found at "+s),$.each(e,function(t,e){$('#remotes-table tr[data-coords="'+e.host+":"+e.port+'"]').first().attr("data-check",o)}),$("#remotes-table .zold-node:not([data-check="+o+"])").remove(),put_markers(a,e)}).fail(function(){createMessage("Remote list retrieve fail, try to refresh page")})}function put_markers(d,t){$.each(t,function(t,e){var o=e.host,s=e.port,a=o+":"+s,r=$('#remotes-table tr[data-coords="'+a+'"]');if(r.length){var n=r.first();$.getJSON("http://"+a+"/",function(t){n.html("<td>"+makeALink(a)+"</td><td>"+t.score.value+"</td><td>"+t.wallets+"</td><td>"+t.version+"</td>"),n.addClass("blink"),setTimeout(function(t){t.removeClass("blink")},3e3,n),o.match(/^[0-9\.]+$/)?put_marker_by_ip(d,o+":"+s,o,s):put_marker_by_host(d,o+":"+s,o,s)}).done(function(){n.removeClass("node-down"),n.addClass("node-up")}).fail(function(){n.removeClass("node-up"),n.addClass("node-down")})}else $("#remotes-table").append('<tr class="zold-node" data-coords="'+a+'"><td>'+makeALink(a)+"</td> <td colspan=3>&nbsp;</td> </tr>")})}function put_marker_by_host(e,o,s,a){$.getJSON("https://api.exana.io/dns/"+s+"/a",function(t){ip=$.grep(t.answer,function(t,e){return"A"==t.type})[0].rdata,console.log("Host "+s+" resolved to "+ip),put_marker_by_ip(e,o,ip,a)}).fail(function(){createMessage("Failed to find IP for "+s)})}function put_marker_by_ip(s,a,r,t){$.getJSON("http://www.geoplugin.net/json.gp?ip="+r,function(t){var e=parseFloat(t.geoplugin_latitude),o=parseFloat(t.geoplugin_longitude);console.log(r+" located at "+e+"/"+o),new google.maps.Marker({position:{lat:e,lng:o},map:s,title:a}),console.log("Marker set for "+a+" at "+e+"/"+o)}).fail(function(){createMessage("Failed to find geo-location for "+r)})}function createMessage(t){messagesRepository.push(t),printMessages(messagesRepository=messagesRepository.reverse().slice(0,8))}function printMessages(t){var e=$(".messages-container");e.html(""),t.forEach(function(t){console.log(t),e.append('<div class="message-warning">'+t+"</div>")})}function makeALink(t){return'<a href="http://'+t+'/">'+t+"</a>"}