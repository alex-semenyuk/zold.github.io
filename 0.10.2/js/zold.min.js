/*! zold 2018-11-05 */

var delay=5e3,seen_nodes=new Set([]);function health_init(){window.location.protocol.startsWith("https")?$(location).attr("href","http://www.zold.io/health.html"):(root=new URLSearchParams(window.location.search).get("start"),null==root&&(root="b1.zold.io"),$("#head").html("Wait a second, we are loading the list of nodes from "+root+"..."),health_discover(root))}function health_discover(t){$.getJSON("http://"+t+"/remotes",function(t){0!=t.all.length?($("#head").hide(),$.each(t.all.sort(function(t){return t.host}),function(t,e){var a=e.host+":"+e.port;seen_nodes.has(a)||(seen_nodes.add(a),$("#health tbody").append('<tr data-addr="'+a+'"><td class="host" style="'+(e.default?"font-weight:bold;":"")+'"><a href="http://'+a+'/" class="alias">'+e.host+'</a></td><td class="port">'+e.port+'</td><td class="ping data"></td><td class="flag data" data-ip="'+e.host+'"></td><td class="platform data"></td><td class="cpus data"></td><td class="memory data"></td><td class="load data"></td><td class="threads data"></td><td class="processes data"></td><td class="score data"></td><td class="wallets data"></td><td class="version data"></td><td class="nscore data"></td><td class="remotes data"></td><td class="history data"></td><td class="queue data"></td><td class="speed data"></td><td class="age data"></td><td class="wallet"></td></tr>'),health_flag(e.host),window.setTimeout(function(){health_node(a)},0))})):$("#head").text("The list of remotes is empty!")}).fail(function(){$("#head").text("Failed to load the list of remotes from "+t)})}function health_flag(t){var a=$('#health td[data-ip="'+t+'"]'),e=a.data("ip");e.match(/^[0-9\.]+$/)&&$.getJSON("https://ssl.geoplugin.net/json.gp?k=af0ad95fd7caa623&ip="+e,function(t){var e=t.geoplugin_countryCode;a.html('<img src="https://flagpedia.net/data/flags/normal/'+e.toLowerCase()+'.png" alt="'+e+'" style="width:1em;"/>')}).fail(function(){a.text("?")})}function health_check_wallet(){var a=$("#wallet").val();$("#health tr[data-addr]").each(function(){var t=$(this).data("addr"),o=$(this).find("td.wallet"),e="http://"+t+"/wallet/"+a+"/balance";o.text("checking...").addClass("gray").removeClass("green"),o.attr("title",e),$.getJSON(e,function(t){o.text(Math.round(parseInt(t)/Math.pow(2,32),2)+"ZLD").removeClass("gray red").addClass("green")}).fail(function(t,e,a){o.text(t.status).addClass("red")})})}function health_node(a){var o=$('#health tr[data-addr="'+a+'"]'),r=new Date;o.find("td.ping").html('<div class="spinner">&nbsp;</div> '),$.ajax({url:"http://"+a+"/",timeout:16e3,success:function(t){var e=new Date-r;o.find("td.ping").removeClass("failure"),o.find("td.ping").text(e).colorize({1e3:"red",500:"orange",0:"green"}),o.find("td.alias").text(t.alias),o.find("td.platform").text(t.platform),o.find("td.cpus").html("<a href='http://"+a+"/farm'>"+t.cpus+"</a>"),o.find("td.memory").text((t.memory/1048576).toFixed(0)).colorize({512:"red",256:"orange",0:"green"}),o.find("td.load").text(t.load.toFixed(2)).colorize({8:"red",4:"orange",0:"green"}),o.find("td.threads").html("<a href='http://"+a+"/threads'>"+t.threads+"</a>"),o.find("td.processes").html("<a href='http://"+a+"/ps'>"+t.processes+"</a>"),o.find("td.score").text(t.score.value).colorize({16:"green",4:"orange",0:"red"}),t.score.expired?o.find("td.score").addClass("cross"):o.find("td.score").removeClass("cross"),o.find("td.wallets").text(t.wallets).colorize({256:"gray",257:"inherit"}),o.find("td.remotes").text(t.remotes).colorize({20:"orange",8:"green",0:"red"}),o.find("td.version").text(t.version+"/"+t.protocol),o.find("td.nscore").html("<a href='/health.html?start="+a+"'>"+t.nscore+"</a>"),o.find("td.age").text(t.hours_alive.toFixed(1)).colorize({1:"green",0:"red"}),o.find("td.history").text(t.entrance.history_size).colorize({8:"green",0:"red"}),o.find("td.queue").text(t.entrance.queue).colorize({32:"red",8:"orange",0:"green"}),o.find("td.speed").text(Math.round(t.entrance.speed)).colorize({32:"red",16:"orange",0:"green"}),health_update_lag(),health_update_nscore(),health_update_cost(),health_discover(a),$("#total_nodes").text(seen_nodes.size)},error:function(t,e,a){o.find("td.ping").text("#"+t.status).addClass("failure")},complete:function(){window.setTimeout(function(){health_node(a)},delay)}})}function health_update_nscore(){var e=0,a=0;$("#health td.nscore").each(function(){var t=$(this).text();t.match(/^[0-9]+$/)&&(n=parseInt(t),n>e&&(e+=n,a+=1))}),e=Math.round(e/a);var o=0;$("#health td.score").each(function(){var t=$(this).text();t.match(/^[0-9]+$/)&&(o+=parseInt(t))}),$("#nscore").html('<span title="average">'+e+'</span>/<span title="actual">'+o+"</span>")}function health_update_cost(){var e=0;$("#health td.cpus").each(function(){var t=$(this).text();t.match(/^[0-9]+$/)&&(e+=parseInt(t))}),$("#total_cpus").text(e);var t=$("#health td.cpus").length,a=$("#health td.cpus").length;$("#total_dollars").text((.16*t*e/a).toFixed(2))}function health_update_lag(){var t=avg("remotes");$("#avg_remotes").text(Math.round(t));var e=avg("speed");$("#avg_speed").text(Math.round(e)).colorize({32:"red",16:"orange",0:"green"});var a=avg("queue");$("#avg_queue").text(a.toFixed(1)).colorize({32:"red",8:"orange",0:"green"});t=avg("remotes");var o=1+Math.log(Math.log(seen_nodes.size))/Math.log(t);$("#hops").text(o.toFixed(2));var r=o*e*(1+a);$("#lag").text(Math.round(r)).colorize({32:"red",16:"orange",0:"green"})}function avg(t){var e=0,a=0;$("#health td."+t).each(function(){var t=$(this).text();t.match(/^[0-9\.]+$/)&&(e+=parseInt(t),a+=1)});var o=0;return 0<a&&(o=e/a),o}function ledger_init(){ledger_refresh(window.location.href.split("?")[1].split("=")[1])}function ledger_refresh(t){$.getJSON("http://b2.zold.io:4096/wallet/"+t,function(t){$("#results").show(),$("#wallet").text(t.id);for(var e=t.body.split("\n"),a="<table>",o=5;o<e.length-1;o++){var r=e[o].split(";");a+="<tr><td><b>"+r[0]+"</b></td><td>"+human_date(r[1])+"</td><td>"+zold_amount(r[2])+"</td><td><a href='ledger.html?wallet="+r[4]+"'>"+r[4]+"</a></td><td>"+r[5]+"</i></a></td></tr>"}$("#transactions").html(a+"</table>")}).fail(function(){console.log("Failed to load the JSON")})}function zold_amount(t){return parseFloat(t/Math.pow(2,32)).toFixed(7)+" ZLD"}function human_date(t){var e=new Date(Date.parse(t)),a=e.getMonth(),o=e.getFullYear(),r=e.getHours(),n=e.getMinutes();return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]+" "+o+" "+r+":"+n}function map_init(){if(window.location.protocol.startsWith("https"))$(location).attr("href","http://www.zold.io/map.html");else{var t=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(55.751244,37.618423),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:2});t.addListener("drag",function(){(t.getBounds().getSouthWest().lat()<-85||85<t.getBounds().getNorthEast().lat())&&t.setOptions({zoom:2,center:new google.maps.LatLng(0,0)})}),map_refresh("b1.zold.io",t)}}function map_refresh(t,a){$.getJSON("http://"+t+"/remotes",function(t){$.each(t.all,function(t,e){e.host.match(/^[0-9\.]+$/)?map_by_ip(a,e.host,e.port):map_by_host(a,e.host,e.port)})})}function map_by_host(a,t,o){$.getJSON("https://api.exana.io/dns/"+t+"/a",function(t){var e=$.grep(t.answer,function(t,e){return"A"==t.type})[0].rdata;map_by_ip(a,e,o)}).fail(function(){console.log("Failed to find IP for "+t)})}function map_by_ip(o,r,n){$.getJSON("http://www.geoplugin.net/json.gp?ip="+r,function(t){var e=parseFloat(t.geoplugin_latitude),a=parseFloat(t.geoplugin_longitude);new google.maps.Marker({position:{lat:e,lng:a},map:o,title:r+":"+n})}).fail(function(){console.log("Failed to find geo-location for "+r)})}delay=1e3;function stress_init(){window.location.protocol.startsWith("https")?$(location).attr("href","http://www.zold.io/stress.html"):stress_refresh()}function stress_refresh(){var a=$("#ping");a.html('<div class="spinner">&nbsp;</div>');var o=new Date;$.getJSON("http://wts.zold.io/stress.json",function(t){var e=new Date-o;a.text(e).colorize({1e3:"red",500:"orange",0:"green"}),$("#age").text(Math.round(60*t.alive_hours*60)+" seconds"),$("#wallets").text(t.wallets.length).colorize({7:"green",0:"red"}),$("#remotes").text(t.remotes).colorize({7:"green",0:"red"}),$("#tps").text(Math.round(t.arrived.total/t.arrived.age,3)),$("#sent").text(t.paid.total),$("#arrived").text(t.arrived.total),$("#waiting").text(Object.keys(t.waiting).length),$("#confirmation_time").text(Math.round(t.arrived.avg/60,2)),push_ok=t.push_ok?t.push_ok.total:0,push_error=t.push_error?t.push_error.total:0,$("#push_ok").text(push_ok+push_error),$("#push_percent").text(Math.round(push_error/(push_ok+push_error)*100,2)),$("#push_time").text(Math.round(t.push_ok.avg)).colorize({16:"red",0:"green"}),pull_ok=t.pull_ok?t.pull_ok.total:0,pull_error=t.pull_error?t.pull_error.total:0,$("#pull_ok").text(pull_ok+pull_error),$("#pull_percent").text(Math.round(pull_error/(pull_ok+pull_error)*100,2)).colorize({0:"red"}),$("#pull_time").text(Math.round(t.pull_ok.avg)).colorize({16:"red",0:"green"}),$("#cycle_time").text(Math.round(t.cycle_ok.avg)).colorize({16:"red",0:"green"}),window.setTimeout(stress_refresh,delay)}).fail(function(){console.log("Failed to load the JSON")})}